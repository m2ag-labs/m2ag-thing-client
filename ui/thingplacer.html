<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <link href="../siteicon.png" rel="apple-touch-icon" type="image/png"/>
    <meta content="m2ag.labs thing client" name="apple-mobile-web-app-title">
    <link href="../siteicon.png" rel="shortcut icon" type="image/png"/>
    <link href="../siteicon.png" rel="mask-icon" type=""/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-table.min.css" rel="stylesheet">
    <title>m2ag.labs.thing.placer</title>
    <style>
        .editor {
            height: 730px
        }

        .navbar {
            height: 40px
        }

        input {
            width: 50px;
        }

        body {
            min-height: 75rem;
            padding-top: 2.5rem;
            overflow: hidden;
        }

    </style>
</head>
<body>
<nav class="navbar navbar-expand-sm navbar-light fixed-top bg-light">
    <div class="container-fluid">
        <div class="navbar-brand"><span id="edit-nav-label">m2ag.labs.thing.placer</span></div>
        <input aria-label="thing" class="form-control me-2" id="target_thing" placeholder="thing"
               type="text">
        <ul class="navbar-nav">
            <li>
                <button class="btn btn-sm btn-outline-success align-self-md-center" id="edit"
                        onclick="clickHandler('edit')"
                        style="margin-left: 30px">
                    <svg class="bi bi-pen" fill="currentColor" height="16" viewBox="0 0 16 16" width="16"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="m13.498.795.149-.149a1.207 1.207 0 1 1 1.707 1.708l-.149.148a1.5 1.5 0 0 1-.059 2.059L4.854 14.854a.5.5 0 0 1-.233.131l-4 1a.5.5 0 0 1-.606-.606l1-4a.5.5 0 0 1 .131-.232l9.642-9.642a.5.5 0 0 0-.642.056L6.854 4.854a.5.5 0 1 1-.708-.708L9.44.854A1.5 1.5 0 0 1 11.5.796a1.5 1.5 0 0 1 1.998-.001zm-.644.766a.5.5 0 0 0-.707 0L1.95 11.756l-.764 3.057 3.057-.764L14.44 3.854a.5.5 0 0 0 0-.708l-1.585-1.585z"/>
                    </svg>
                </button>
            </li>
            <li>
                <button class="btn btn-sm btn-outline-success" id="save" onclick="clickHandler('save')"
                        style="display: none; margin-left: 30px">
                    <svg class="bi bi-save2" fill="currentColor" height="16" viewBox="0 0 16 16" width="16"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M2 1a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h12a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1H9.5a1 1 0 0 0-1 1v4.5h2a.5.5 0 0 1 .354.854l-2.5 2.5a.5.5 0 0 1-.708 0l-2.5-2.5A.5.5 0 0 1 5.5 6.5h2V2a2 2 0 0 1 2-2H14a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h2.5a.5.5 0 0 1 0 1H2z"/>
                    </svg>
                </button>
            </li>
            <li>
                <button class="btn btn-sm btn-outline-danger" id="cancel" onclick="clickHandler('cancel')"
                        style="display: none; margin-left: 30px">
                    <svg class="bi bi-x-square" fill="currentColor" height="16" viewBox="0 0 16 16" width="16"
                         xmlns="http://www.w3.org/2000/svg">
                        <path d="M14 1a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H2a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1h12zM2 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H2z"/>
                        <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z"/>
                    </svg>
                </button>
            </li>
        </ul>
    </div>
</nav>
<main>
    <div class="bg-light rounded editor" id="ace_editor">no data</div>
</main>
<!--script src="../js/vendor/jquery.min.js"></script>
<script src="../js/vendor/popper.min.js"></script>
<script src="../js/vendor/bootstrap.min.js"></script-->
<script src="js/vendor/ace/ace.js"></script>


<script>
    //Get things and helpers from git hub
    //Combine into on object
    //stringify and place in ace editor
    const github_url = `https://raw.githubusercontent.com/m2ag-labs/m2ag-things/main`
    const m2aglabs_url = `https://thing-builder-api.web.app/api/v1`
    const requestHeaders = new Headers();
    requestHeaders.append("Content-Type", "application/json");
    const getOptions = {
        method: 'GET',
        headers: requestHeaders,
        redirect: 'follow'
    }
    const putOptions = {
        method: 'PUT',
        headers: requestHeaders,
        redirect: 'follow',
        body: ''
    }
    const version_info = 'beta 1, 2021'
    const opts = {auth: '', thing: {}, helper: {}, target: ''}
    const editor = ace.edit("ace_editor")
    editor.session.setMode("ace/mode/text")
    editor.session.setUseWrapMode(true)
    editor.setTheme("ace/theme/chrome")
    editor.setOptions({fontSize: "12pt"});
    //TODO: add editor options to nav bar
    const clickHandler = () => {
        editor.session.setValue('')
        opts.target = document.getElementById('target_thing').value
        getThings(`/things/${opts.target}/${opts.target}.json`)
            .then(response => {
                opts.thing = response
                getHelper()
            }).catch(error => alert(error))

    }

    document.getElementById('target_thing').addEventListener("keyup", function (event) {
        if (event.code === 'Enter') {
            clickHandler()
        }
    });

    const updateUi = () => {
        let file = {thing: opts.thing, helper: opts.helper, info: {}}
        editor.session.setValue(JSON.stringify(file))
        editor.selectAll()
    }

    const getHelper = () => {
        getThings(`/things/${opts.target}/${opts.target}.py`, 'text')
            .then(response => {
                // if not found its ok
                opts.helper = response
                updateUi()
            }).catch(error => {
                if (error === '404') {
                    updateUi()
                } else {
                    alert(error)
                }
            }
        )
    }


    /**
     * Can't get fetch to get the module files from git hub due to cors issues -- xhr works.
     * It's pretty fast too. Wrapped in a promise
     * @param path  to a thing, component or other resource on git hub
     * @param type  json or text
     * @returns {Promise<>}
     */
    const getThings = (path = '', type = 'json') => {
        return new Promise((resolve, reject) => {
            let xhr = new XMLHttpRequest();
            let timeout
            xhr.addEventListener("readystatechange", function () {
                if (this.readyState === 4) {
                    clearTimeout(timeout)
                    if (this.responseText.includes("404: Not Found")) {
                        reject('404')
                    } else {
                        if (type === 'json') {
                            try {
                                resolve(JSON.parse(this.responseText))
                            } catch (e) {
                                reject("unable to parse json", path)
                            }
                        } else {
                            resolve(this.responseText)
                        }
                    }
                }
            });
            xhr.open("GET", `${github_url}/${path}?_=${Date.now()}`);
            xhr.send();
            timeout = setTimeout(() => {
                    reject('request timeout')
                }, 3000
            )
        });
    }

    const init = () => {

        let param = window.location.search.substring(1, window.location.search.length);
        param = param.split('&')
        for (const i in param) {
            const ix = param[i].split('=')
            opts[ix[0]] = ix[1]
        }
        if (opts.auth === '') {
            alert('no auth token')
        } else {
            requestHeaders.append("Authorization", `Basic ${opts['auth']}`);
        }

        /* getThings('/things/things.json')
             .then(response => {
                 opts.data = response
             }).catch(error => alert(error))
         */

        document.title = window.location.hostname
    }
    window.addEventListener("resize", () => {
        document.getElementById('ace_editor').style.height = `${window.innerHeight - 90}px`
    })
    window.addEventListener("load", init)
    window.onmessage = (event) => {
        document.getElementById('ace_editor').style.height = `${event.data - 90}px`
        editor.resize()
    }
    //window.top.postMessage('resize', window.origin)
    document.getElementById('ace_editor').style.height = `${window.innerHeight - 90}px`

</script>

</body>
</html>
