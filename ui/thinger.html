<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <link href="../siteicon.png" rel="apple-touch-icon" type="image/png"/>
    <meta content="m2ag.labs thing client" name="apple-mobile-web-app-title">
    <link href="../siteicon.png" rel="shortcut icon" type="image/png"/>
    <link href="../siteicon.png" rel="mask-icon" type=""/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-table.min.css" rel="stylesheet">
    <title>m2ag.labs.thinger</title>
    <style>
        main {
            position: relative;
            height: auto;
            width: 100%;
            border: 0;
        }

        #status_f {
            width: 15%
        }

        #component_f {
            width: 25%;
        }

        #driver_f {
            width: 40%;
        }

        #detail_f {
            width: 15%
        }

        button {
            width: 100%;
        }

        tr {
            alignment: center;
            text-align: center;
        }

    </style>
</head>
<body>
<main class="container-fluid">
    <table data-pagination="true"
           data-search="true"
           id="things_table"
    >
        <thead>
        <tr>
            <th data-field='status' data-sortable="true" id="status_f">status</th>
            <th data-field='component' data-sortable="true" id="component_f">component</th>
            <th data-field='driver' data-sortable="true" id="driver_f">driver</th>
            <th data-field='detail' id="detail_f">detail</th>
        </tr>
        </thead>
    </table>
</main>
<script src="../js/vendor/jquery.min.js"></script>
<script src="../js/vendor/popper.min.js"></script>
<script src="../js/vendor/bootstrap.min.js"></script>
<script src="js/vendor/bootstrap-table.min.js"></script>
<script src="js/vendor/bootstrap-table-toolbar.min.js"></script>


<script>
    const api_url = `${window.location.protocol}//${window.location.hostname}:5000`
    const github_url = `https://raw.githubusercontent.com/m2ag-labs/m2ag-things/beta1`
    const requestHeaders = new Headers();
    requestHeaders.append("Content-Type", "application/json");
    const getOptions = {
        method: 'GET',
        headers: requestHeaders,
        redirect: 'follow'
    }
    const putOptions = {
        method: 'PUT',
        headers: requestHeaders,
        redirect: 'follow',
        body: ''
    }
    const version_info = 'beta 1, 2021'
    const opts = {auth: '', opts: ''}
    const $table = $('#things_table')

    /**
     * Can't get fetch to get the module files from git hub due to cors issues -- xhr works.
     * It's pretty fast too. Wrapped in a promise
     * @param path  to a thing, component or other resource on git hub
     * @param type  json or text
     * @returns {Promise<>}
     */
    const getThings = (path = '', type = 'json') => {
        return new Promise((resolve, reject) => {
            let xhr = new XMLHttpRequest();
            let timeout
            xhr.addEventListener("readystatechange", function () {
                if (this.readyState === 4) {
                    clearTimeout(timeout)
                    if (this.responseText.includes("404: Not Found")) {
                        reject('file not found')
                    } else {
                        if (type === 'json') {
                            try {
                                resolve(JSON.parse(this.responseText))
                            } catch (e) {
                                reject("unable to parse json", path)
                            }
                        } else {
                            resolve(this.responseText)
                        }
                    }
                }
            });
            xhr.open("GET", `${github_url}/${path}?_=${Date.now()}`);
            xhr.send();
            timeout = setTimeout(() => {
                    reject('request timeout')
                }, 3000
            )
        });
    }

    const addLocalConfig = (data) => {
        fetch(`${api_url}/config`, getOptions)
            .then(response => response.json())
            .then(result => buildTable(result.data, data)) // jshint ignore:line
            .catch(error => alert(error))
    }

    const removeThing = (thing) => {
        console.log(thing)
    }

    const addThing = (thing) => {
        console.log(thing)
    }

    const buildTable = (result, data) => {
        //TODO: if data is an error -- message about internet connection and no table
        //TODO: maybe give a warning when going to this page -- let the user know it is online
        let table_data = []
        for (let i in data) {
            let c = {}
            if (result.enabled.includes(i)) {
                c['status'] = `<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sun" viewBox="0 0 16 16">
  <path d="M8 11a3 3 0 1 1 0-6 3 3 0 0 1 0 6zm0 1a4 4 0 1 0 0-8 4 4 0 0 0 0 8zM8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0zm0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13zm8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5zM3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8zm10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0zm-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0zm9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707zM4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708z"/>
</svg>`
            } else if (result.available.includes(i)) {
                c['status'] = `<button class="btn btn-sm btn-outline-danger" onclick="removeThing('${i}')">
 <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-minus" viewBox="0 0 16 16">
  <path d="M5.5 8a.5.5 0 0 1 .5-.5h4a.5.5 0 0 1 0 1H6a.5.5 0 0 1-.5-.5z"/>
  <path d="M4 0a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2h8a2 2 0 0 0 2-2V2a2 2 0 0 0-2-2H4zm0 1h8a1 1 0 0 1 1 1v12a1 1 0 0 1-1 1H4a1 1 0 0 1-1-1V2a1 1 0 0 1 1-1z"/>
</svg>
</button>`
            } else {
                c['status'] = `<button class="btn btn-sm btn-outline-success" onclick="addThing('${i}')">
<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-file-plus" viewBox="0 0 16 16">
  <path d="M8.5 6a.5.5 0 0 0-1 0v1.5H6a.5.5 0 0 0 0 1h1.5V10a.5.5 0 0 0 1 0V8.5H10a.5.5 0 0 0 0-1H8.5V6z"/>
  <path d="M2 2a2 2 0 0 1 2-2h8a2 2 0 0 1 2 2v12a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2zm10-1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V2a1 1 0 0 0-1-1z"/>
</svg>
</button>`
            }

            c['component'] = i
            if ('driver' in data[i]) {
                c['driver'] = data[i]['driver']
            } else {
                c['driver'] = 'none'
            }
            c['detail'] = '<button class="btn btn-sm btn-outline-primary">detail</button>'
            table_data.push(c)
        }
        $table.bootstrapTable({data: table_data})
    }

    const init = () => {

        let param = window.location.search.substring(1, window.location.search.length);
        param = param.split('&')
        for (const i in param) {
            const ix = param[i].split('=')
            opts[ix[0]] = ix[1]
        }
        if (opts.auth === '') {
            alert('no auth token')
        } else {
            requestHeaders.append("Authorization", `Basic ${opts['auth']}`);
            //pollService()
            //target_interval = setInterval(pollService, 3000)
        }
        getThings('/things/things.json')
            .then(response => addLocalConfig(response)).catch(error => buildTable(error))

        document.title = window.location.hostname
    }
    window.addEventListener("load", init)
</script>

</body>
</html>
