<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <link href="../siteicon.png" rel="apple-touch-icon" type="image/png"/>
    <meta content="m2ag.labs thing client" name="apple-mobile-web-app-title">
    <link href="../siteicon.png" rel="shortcut icon" type="image/png"/>
    <link href="../siteicon.png" rel="mask-icon" type=""/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <link href="css/bootstrap-table.min.css" rel="stylesheet">
    <title>m2ag.labs.thinger</title>
    <style>
        iframe {
            position: relative;
            height: 750px;
            width: 100%;
            border: 0;
        }

        .navbar {
            padding-bottom: 0;
            height: 50px;
        }

    </style>
</head>
<body>
<nav class="navbar navbar-expand-sm navbar-light fixed-top bg-light">
    <div class="container-fluid">
        <div class="navbar-brand"><span id="edit-nav-label">m2ag.labs.thinger</span></div>
        <div class="" id="navbarCollapse">
            <ul class="navbar-nav">
            </ul>
            <div class="d-flex">

            </div>
        </div>
    </div>
</nav>
<main class="container-fluid">
    <table id="things_table">
        <thead>
        <tr>
            <th data-field='status'>status</th>
            <th data-field='component'>component</th>
            <th data-field='driver'>driver</th>
            <th data-field='detail'>detail</th>
        </tr>
        </thead>
    </table>
</main>
<!--script src="js/vendor/popper.min.js"></script>
<script src="js/vendor/bootstrap.min.js"></script-->
<script src="../js/vendor/jquery.min.js"></script>
<script src="https://unpkg.com/bootstrap-table@1.18.3/dist/bootstrap-table.min.js"></script>




<script>
    //TODO: move to path -- tornado wsqi
    const api_url = `${window.location.protocol}//${window.location.hostname}:5000`
    const github_url = `https://raw.githubusercontent.com/m2ag-labs/m2ag-things/beta1`
    const requestHeaders = new Headers();
    requestHeaders.append("Content-Type", "application/json");
    const getOptions = {
        method: 'GET',
        headers: requestHeaders,
        redirect: 'follow'
    }
    const putOptions = {
        method: 'GET',
        headers: requestHeaders,
        redirect: 'follow'
    }

    const version_info = 'beta 1, 2021'
    let opts = {auth: '', opts: ''}
    let $table = $('#things_table')

    /**
     * Can't get fetch to get the module files from git hub due to cors issues -- xhr works.
     * It's pretty fast too. Wrapped in a promise
     * @param path  to a thing, component or other resource on git hub
     * @param type  json or text
     * @returns {Promise<>}
     */
    const getThings = (path = '', type = 'json') => {
        return new Promise((resolve, reject) => {
            let xhr = new XMLHttpRequest();
            let timeout
            xhr.addEventListener("readystatechange", function () {
                if (this.readyState === 4) {
                    clearTimeout(timeout)
                    if (this.responseText.includes("404: Not Found")) {
                        reject('file not found')
                    } else {
                        if (type === 'json') {
                            try {
                                resolve(JSON.parse(this.responseText))
                            } catch (e) {
                                reject("unable to parse json", path)
                            }
                        } else {
                            resolve(this.responseText)
                        }
                    }
                }
            });
            xhr.open("GET", `${github_url}/${path}?_=${Date.now()}`);
            xhr.send();
            timeout = setTimeout(() => {
                    reject('request timeout')
                }, 3000
            )
        });
    }

    const buildTable = (data) => {
        //TODO: if data is an error -- message about internet connection and no table
        //TODO: maybe give a warning when going to this page -- let the user know it is online
        let table_data = []
        for(let i in data){
            let c = {}
            c['status'] = '<button class="btn btn-sm btn-outline-warning">remove</button>'
            c['component'] = i
            if('driver' in data[i]){
                c['driver'] = data[i]['driver']
            } else {
                c['driver'] = 'none'
            }
            c['detail'] = '<button class="btn btn-sm btn-outline-primary">detail</button>'
            table_data.push(c)
        }
        $table.bootstrapTable({data: table_data})
    }

    const init = () => {

        let param = window.location.search.substring(1, window.location.search.length);
        param = param.split('&')
        for (const i in param) {
            const ix = param[i].split('=')
            opts[ix[0]] = ix[1]
        }
        if (opts.auth === '') {
            alert('no auth token')
        } else {
            requestHeaders.append("Authorization", `Basic ${opts['auth']}`);
            //pollService()
            //target_interval = setInterval(pollService, 3000)
        }
        getThings('/things/things.json')
            .then(response => buildTable(response)).catch(error => buildTable(error))

        /*
        fetch(`${github_url}/things/things.json`, getOptions)
            .then(response => response.json())
            .then(result => console.log(result)) // jshint ignore:line
            .catch(error => alert(error))
         */
        document.title = window.location.hostname
    }
    window.addEventListener("load", init)
</script>

</body>
</html>
