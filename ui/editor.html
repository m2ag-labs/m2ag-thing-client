<!doctype html>
<html lang="en">
<head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <link href="../siteicon.png" rel="apple-touch-icon" type="image/png"/>
    <meta content="m2ag.labs editor" name="apple-mobile-web-app-title">
    <link href="../siteicon.png" rel="shortcut icon" type="image/png"/>
    <link href="../siteicon.png" rel="mask-icon" type=""/>
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <link href="../css/bootstrap.min.css" rel="stylesheet">
    <title>m2ag.labs.thing.ui.editor</title>
</head>
<body>
    <!--ui page -->
    <div id="ace_editor" style="height: 700px;">no data</div>

<script src="js/ace/ace.js"></script>
<script>
    const opts = {
        path : '',
        auth : '',

    } //component to look at, update method
    const editor = ace.edit("ace_editor")
    editor.setTheme("ace/theme/chrome")
    editor.setOptions({fontSize: "12pt"});
    let auth = 'cGk6cmFzcGJlcnJ5'
    const api_url = `${window.location.protocol}//${window.location.hostname}:5000`
    const requestHeaders = new Headers();
    requestHeaders.append("Content-Type", "application/json");
    const getOptions = {
        method: 'GET',
        headers: requestHeaders,
        redirect: 'follow'
    };
    const putOptions = {
        method: 'PUT',
        headers: requestHeaders,
        body: '',
        redirect: 'follow'
    }

    function remove_non_ascii(str) {
        if ((str === null) || (str === ''))
            return false;
        else
            str = str.toString();
        return str.replace(/%E2%80%8C/g, '');
    }

    function init() {
        //sets up an editor in its own page. Handles updates to mods and config.
        //?module=<module>
        // TODO: where are the non ascii chars comming from?
        let param = window.location.search.substring(1, window.location.search.length);
        param = remove_non_ascii(param)
        param = param.split('&')
        for (const i in param) {
            const ix = param[i].split('=')
            opts[ix[0]] = ix[1]
        }
        //get the defaults from the thing and setup fields
        //get bearer token from the query string
        if (opts['auth'] !== undefined && opts['auth'] !== '') {
            auth = `Basic ${opts['auth']}`
            requestHeaders.append("Authorization", auth);
            fetch(`${api_url}/${opts.path}`, getOptions)
                .then(response => response.json())
                .then(result => updateUi(result))
                .catch(error => console.log('error', error))
        } else {
            console.log('missing auth token') // gotta have a token
        }
    }

    function updateUi(result) {
        switch(opts.type){
            case 'json':
                editor.session.setMode("ace/mode/json")
                editor.session.setValue(JSON.stringify(result.data, null, 2))
                break
            case 'python':
                editor.session.setMode("ace/mode/python")
                editor.session.setValue(result.data)
                break
            default:
                editor.session.setMode("ace/mode/text")
                editor.session.setValue(result.data)
        }
        editor.setReadOnly(true);
    }


    window.addEventListener("load", init);
</script>
</body>
</html>








